<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="logistics.work.models.dao.AssessDao">
    <select id="queryAllAssess" parameterType="java.util.Map" resultType="logistics.work.models.dto.ShowAssessDto">
        select
        wsd.id,
        sc1.name as finish_status,
        wp.work_name,
        wp.work_content,
        sc.name as workFrom,
        wp.work_minutes,
        ws.date as beginTime,
        wsd.finish_time,
        wa.assess_grade,
        employee.emp_name
        from work_schedule_detail as wsd
        left join work_pool as wp
        on wp.id=wsd.work_id
        left join work_assess as wa
        on wsd.id=wa.schedule_detail_id
        left join work_schedule as ws
        on ws.id=wsd.schedule_id
        left join `user`
        on ws.user_id=`user`.id
        left join employee
        on `user`.employee_id=employee.id
        left join sys_config as sc
        on sc.`code`=wp.work_from
        left join sys_config as sc1
        on sc1.`code`=wsd.finish_status
        <where>
            assess_time is null
            and ws.submit_status like 'submitted'
            <if test="assessGrade!=null">
                and assess_grade like #{assessGrade}
            </if>
            <if test="employeeId!=null">
                and employee_id=#{employeeId}
            </if>
            <if test="finishStatus!=null">
                and finish_status=#{finishStatus}
            </if>
            <if test="workFrom!=null">
                and wp.work_From like #{workFrom}
            </if>
            <if test="workName!=null">
                and wp.work_name like "%"#{workName}"%"
            </if>
            <if test="beginTime!=null">
                and ws.date>#{beginTime}
            </if>
            <if test="endTime!=null">
                and #{endTime}>finish_time
            </if>
        </where>
        order by ws.date desc, finish_time desc
        limit #{pageStart},#{pageSize}
    </select>
    <select id="queryAllAssessCount" resultType="Integer" parameterType="java.util.Map">
        select count(*)
        from work_schedule_detail as wsd
        left join work_pool as wp
        on wp.id=wsd.work_id
        left join work_assess as wa
        on wsd.id=wa.schedule_detail_id
        left join work_schedule as ws
        on ws.id=wsd.schedule_id
        left join `user`
        on ws.user_id=`user`.id
        left join employee
        on `user`.employee_id=employee.id
        left join sys_config as sc
        on sc.`code`=wp.work_from
        left join sys_config as sc1
        on sc1.`code`=wsd.finish_status
        <where>
            assess_time is null
            and ws.submit_status like 'submitted'
            <if test="assessGrade!=null">
                and assess_grade like #{assessGrade}
            </if>
            <if test="employeeId!=null">
                and employee_id=#{employeeId}
            </if>
            <if test="finishStatus!=null">
                and wsd.finish_status like #{finishStatus}
            </if>
            <if test="workFrom!=null">
                and wp.work_From like #{workFrom}
            </if>
            <if test="workName!=null">
                and wp.work_name like "%"#{workName}"%"
            </if>
            <if test="beginTime!=null">
                and ws.date>#{beginTime}
            </if>
            <if test="endTime!=null">
                and #{endTime}>finish_time
            </if>
        </where>
    </select>
    <insert id="assessWork" parameterType="logistics.work.models.domain.WorkAssess">
        insert into work_assess(assess_user_id,assess_time,assess_grade,assess_desc,schedule_detail_id)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.assessUserId},NOW(),#{item.assessGrade},#{item.assessDesc},#{item.scheduleDetailId})
        </foreach>
    </insert>
    <select id="employeeQueryAllAssess" parameterType="java.util.Map" resultType="logistics.work.models.dto.ShowAssessDto">
        select
        wsd.id,
        sc1.name as finish_status,
        wp.work_name,
        wp.work_content,
        sc.name as workFrom,
        wp.work_minutes,
        ws.date as beginTime,
        wsd.finish_time,
        wa.assess_grade,
        wa.assess_desc,
        case when wa.id is null then 0 else 1 end as assessStatus
        from work_schedule_detail as wsd
        left join work_pool as wp
        on wp.id=wsd.work_id
        left join work_assess as wa
        on wsd.id=wa.schedule_detail_id
        left join work_schedule as ws
        on ws.id=wsd.schedule_id
        left join sys_config as sc
        on sc.`code`=wp.work_from
        left join sys_config as sc1
        on sc1.`code`=wsd.finish_status
        <where>
            ws.submit_status like 'submitted'
            <if test="assessGrade!=null">
                and assess_grade like #{assessGrade}
            </if>
            <if test="finishStatus!=null">
                and finish_status=#{finishStatus}
            </if>
            <if test="workName!=null">
                and wp.work_name like "%"#{workName}"%"
            </if>
            <if test="workFrom!=null">
                and wp.work_from like #{workFrom}
            </if>
            <if test="beginTime!=null">
                and ws.date>#{beginTime}
            </if>
            <if test="endTime!=null">
                and #{endTime}>finish_time
            </if>
            <if test="assessStatus==1">
                and wa.id is not null
            </if>
            <if test="assessStatus==0">
                and wa.id is null
            </if>
        </where>
        order by ws.date desc, finish_time desc
        limit #{pageStart},#{pageSize}
    </select>
    <select id="employeeQueryAllAssessCount" parameterType="java.util.Map" resultType="Integer">
        select
        count(*)
        from work_schedule_detail as wsd
        left join work_pool as wp
        on wp.id=wsd.work_id
        left join work_assess as wa
        on wsd.id=wa.schedule_detail_id
        left join work_schedule as ws
        on ws.id=wsd.schedule_id
        left join sys_config as sc
        on sc.`code`=wp.work_from
        left join sys_config as sc1
        on sc1.`code`=wsd.finish_status
        <where>
            ws.submit_status like 'submitted'
            <if test="assessGrade!=null">
                and assess_grade like #{assessGrade}
            </if>
            <if test="finishStatus!=null">
                and finish_status=#{finishStatus}
            </if>
            <if test="workName!=null">
                and wp.work_name like "%"#{workName}"%"
            </if>
            <if test="workFrom!=null">
                and wp.work_from like #{workFrom}
            </if>
            <if test="beginTime!=null">
                and ws.date>#{beginTime}
            </if>
            <if test="endTime!=null">
                and #{endTime}>finish_time
            </if>
        </where>
    </select>
</mapper>